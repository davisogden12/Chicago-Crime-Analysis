---
title: "Project 5 - Spatial Clustering and Structure of Crimes in the City of Chicago"
output:
  word_document:
    reference_docx: CE 597 Project Report Template.docx
---

# Abstract

------------------------------------------------------------------------

# Data Exploration

```{r setup}
library(stringr)
library(rmarkdown)
library(sf)
library(ggplot2)
library(dplyr)
library(stringi)
library(lubridate)
library(mapview)
library(leafpop)
library(spatstat)
library(dbscan)
library(RColorBrewer)
library(nngeo)
library(tibble)
library(factoextra)
library(png)
library(spatstat)
knitr::opts_chunk$set(echo=FALSE, include = FALSE, fig.width = 5, fig.height = 3,
                      fig.align = 'center')
data=read.csv('CrimesChicago20220225.csv')
data=data[,c('DATE..OF.OCCURRENCE','PRIMARY.DESCRIPTION','BEAT',
              'WARD','LATITUDE','LONGITUDE')]
data=na.omit(data)
data$DATE..OF.OCCURRENCE=as.POSIXlt(data$DATE..OF.OCCURRENCE,
                                    tz='America/Detroit',
                                    tryFormats ='%m/%d/%Y %I:%M:%S %p')
data=data%>%
  rename(DATE=DATE..OF.OCCURRENCE,DESCRIPTION=PRIMARY.DESCRIPTION)
```

```{r Task_1-1, echo=TRUE, fig.align='center', fig.height=3, fig.width=5, include=TRUE}
data=data%>%
  rename_with(.fn = function(x){str_to_title(x)})%>%
  mutate(Day=wday(Date,label=TRUE)) %>%
  mutate(Month=month(Date,label=TRUE))%>%
  mutate(Hour=hour(Date))
ggplot(data = data, aes(x=Hour))+
  stat_count(fill='lightblue',color='black')+
  labs(title = 'Hourly Crime Distribution')+
  ylab('Frequency')+
  scale_x_discrete(breaks=1:23, limits=as.character(1:23))+
  theme_gray()+
  theme(plot.title = element_text(hjust = 0.5, size = 12))
```

```{r Task_1-2, echo=TRUE, include=TRUE}
#group according to crime "category"
violent=str_c(c('HOMICIDE','ASSAULT','BATTERY'), collapse = '|')
theft=str_c(c('MOTOR VEHICLE THEFT','ROBBERY','BURGLARY','THEFT'), collapse = '|')
narcotic=str_c(c('NARCOTICS','OTHER NARCOTIC VIOLATION'), collapse = '|')
data_filtered=data%>%
  mutate(Category=case_when(str_detect(Description,violent)~'Violent',
                        str_detect(Description,theft)~'Theft',
                        str_detect(Description,narcotic)~'Drug',
                        .default = 'Other' ))%>%
  filter(str_detect(Category,'Violent|Theft|Drug'))
head(data_filtered)
```

```{r stacked_hist, echo=TRUE, fig.height=3, fig.width=5}
#hourly crime distribution by category of crime
data_filtered%>%
  group_by(Category,Hour)%>%
  ggplot(aes(x=Hour,fill=Category))+
  labs(title='Hourly Crime Distribution')+
  ylab('Frequency')+
  stat_count(color='black')+
  scale_x_discrete(breaks=1:23, limits=as.character(1:23))+
  theme_grey()+
  theme(plot.title = element_text(hjust = 0.5, size = 12))

```

```{r Task_1-3}
data_sf=st_as_sf(data_filtered,
                 coords = c('Longitude','Latitude'),
                 crs = 'EPSG:4326')
data_sf=data_sf%>%
  filter(!is.na(geometry))
shp=list.files(pattern = '.shp')
mapviewOptions(basemaps='OpenStreetMap', fgb = FALSE)
crime_map=mapview(data_sf,
                  zcol='Category',
                  col.regions=brewer.pal(3,'Dark2'),
                  legend=TRUE,
                  popup=popupTable(x=data_sf,
                                   row.numbers=FALSE,
                                   feature.id=FALSE),
                  layer.name='Crime Spatial Distribution')
knitr::include_graphics('mapshot.png')
```

------------------------------------------------------------------------

# Spatial Clustering

```{r density}
violent=data_filtered%>%
  filter(Category=='Violent')%>%
  select(Longitude,Latitude)
ggplot(data=violent,aes(x=Longitude, y=Latitude))+
  geom_density2d_filled(bins=5, color='white')+
  labs(title='Violent Crime Density')+
  theme_grey()+
  theme(plot.title = element_text(hjust = 0.5, size = 12),
        legend.position = 'none')
```

```{r db_outside peaks}
violent%>%
  scale()%>%
dbscan(eps=0.18, minPts = 600)%>%
  fviz_cluster(data = violent, geom = 'point',
               main = 'DBSCAN Clustering of Violent Crimes', pointsize = 0.05)+
  theme(plot.title = element_text(hjust = 0.5, size = 12))
```

large eps less outliers
small eps more outliers
small eps and large minPts will yield extremely high peak points and a lot of noise points, meaning that you may miss patterns on a more local level.

```{r db_high_peaks}
db_violent=violent%>%
  scale()%>%
dbscan(eps=0.15, minPts = 1150)
db_violent_plot=fviz_cluster(db_violent,data = violent, geom = 'point',
               main = 'DBSCAN Clustering of Violent Crimes', pointsize = 0.05)+
  theme(plot.title = element_text(hjust = 0.5, size = 12))
```
now lets try Kmeans
```{r kmeans}
k_violent=violent%>%
  scale()%>%
  kmeans(centers = 5)
k_violent_plot=fviz_cluster(k_violent,data = violent, geom = 'point',
               main = 'Kmeans Clustering of Violent Crimes', pointsize = 0.05)+
  theme(plot.title = element_text(hjust = 0.5, size = 12))
```

------------------------------------------------------------------------

# Spatial Structure

```{r}
op_violent=
```

------------------------------------------------------------------------

# Clustering Method Implementation

------------------------------------------------------------------------

# Summary/Concluding Remarks

------------------------------------------------------------------------

# Appendix

```{r daily_crime_dist}
#daily crime distribution
knitr::opts_chunk$set(echo = TRUE)
ggplot(data = data, aes(x=Day))+
  stat_count(fill='lightblue',color='black')+
  labs(title='Daily Crime Distribution')+
  xlab('Day')+
  ylab('Frequency')+
  scale_x_discrete()+
  theme_gray()+
  theme(plot.title = element_text(hjust = 0.5, size = 12))
```

```{r}
#monthly crime distribution
ggplot(data = data, aes(x=Month))+
  stat_count(fill='lightblue',color='black')+
  labs(title='Monthly Crime Distribution')+
  ylab('Frequency')+
  scale_x_discrete()+
  theme_gray()+
  theme(plot.title = element_text(hjust = 0.5, size = 12))
```

```{r, fig.height=5}
#monthly crime distribution
ggplot(data = data, aes(x=Description))+
  stat_count(fill='lightblue',color='black')+
  labs(title='Crime Distribution by Category')+
  ylab('Frequency')+
  theme_grey()+
  theme(axis.text.y = element_text(size = 7))+
  coord_flip()+
  theme(plot.title = element_text(hjust = 0.5, size = 12))
```
```{r Task_2_theft}
theft=data_filtered%>%
  filter(Category=='Theft')%>%
  select(Longitude,Latitude)

db_theft=theft%>%
  scale()%>%
dbscan(eps=0.15, minPts = 1150)
  fviz_cluster(db_theft,data = theft, geom = 'point',
               main = 'DBSCAN Clustering of Theft Crimes', pointsize = 0.05)+
  theme(plot.title = element_text(hjust = 0.5, size = 12))
  
k_theft=theft%>%
  scale()%>%
  kmeans(centers = 5)
  fviz_cluster(k_theft,data = theft, geom = 'point',
               main = 'Kmeans Clustering of Theft Crimes', pointsize = 0.05)+
  theme(plot.title = element_text(hjust = 0.5, size = 12))
  kNNdistplot()
```

